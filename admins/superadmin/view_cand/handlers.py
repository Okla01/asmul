"""
ĞœĞ¾Ğ´ÑƒĞ»ÑŒ `handlers.py` â€” Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ° Â«Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹Â» Ğ² Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°.

Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:
1. ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞº ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ† Ğ¿Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞµ Â«Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹Â» Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¼ Ğ¼ĞµĞ½Ñ.
2. Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ inlineâ€‘Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¤Ğ˜Ğ / username (Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ `ps:`).
3. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹ Ñ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Â Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ†Ğ¸ĞºĞ»Ğ°.
4. ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ñ†Ğ¸ĞºĞ»Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· callbackâ€‘ĞºĞ½Ğ¾Ğ¿ĞºĞ¸.
5. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Â«ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°Â».

â€¼ï¸  Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ½Ğ¾ÑÑÑ‚ Ñ‡Ğ¸ÑÑ‚Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸.
"""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#           Ğ˜ĞœĞŸĞĞ Ğ¢Ğ«
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âš™ï¸  aiogram
from aiogram import F, types                              # F â€” Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹, types â€” Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹ Telegram API
from aiogram.exceptions import TelegramAPIError, TelegramBadRequest
from aiogram.fsm.context import FSMContext                 # ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ FSM (Finiteâ€‘State Machine)
from aiogram.types import (
    InlineQueryResultArticle, InputTextMessageContent,
    InputMediaPhoto,
)
from aiogram.utils.keyboard import InlineKeyboardBuilder

# ğŸ Â ĞœĞ¾Ğ´ÑƒĞ»Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
from admins.filters.is_admin import IsAdmin                # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Â«Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°Â»
from admins.superadmin.view_cand.states import PSearch     # Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ FSM Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ° Â«Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹Â»
from admins.superadmin.view_cand.keyboards import entry_kb, card_kb  # ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°
from admins.utils import build_admin_card_text             # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ° ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹
from db.database import (
    get_participant_card,      # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹ (Ğ¿Ğ¾ ID Ğ¸ Ñ†Ğ¸ĞºĞ»Ñƒ)
    get_photo_or_none,         # Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ bytesâ€‘Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ»Ğ¸ None, ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
    search_users_by_fio,       # ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ Ğ¤Ğ˜Ğ/username/â€¦
)
from config import dp, bot                                 # Ğ”Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€ Ğ¸ Bot Ğ¸Ğ· aiogram


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. ĞšĞ½Ğ¾Ğ¿ĞºĞ° Â«Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹Â» Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¼ Ğ¼ĞµĞ½Ñ ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.callback_query(F.data == "sa_participants", IsAdmin())
async def p_open_search(cb: types.CallbackQuery, state: FSMContext):
    """ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞºÑ€Ğ°Ğ½ Ğ¿Ğ¾Ğ¸ÑĞºĞ° ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†.

    â€¢ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ FSM Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ `WaitingInline`.
    â€¢ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ ID ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñâ€‘Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ¸ (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¾Ğ¹).
    â€¢ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ + Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Â«ğŸ” ĞĞ°Ğ¹Ñ‚Ğ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†ÑƒÂ».
    """
    # 1ï¸âƒ£  Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
    await state.set_state(PSearch.WaitingInline)
    await state.update_data(prompt_msg_id=cb.message.message_id)

    # 2ï¸âƒ£  ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    await cb.message.edit_text(
        "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ĞĞ°Ğ¹Ñ‚Ğ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†ÑƒÂ» Ğ¸ Ğ½Ğ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¤Ğ˜Ğ / username.\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½ÑƒĞ¶Ğ½ÑƒÑ Ğ¸Ğ· Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰ĞµĞ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ°.",
        reply_markup=entry_kb(),
    )
    await cb.answer()  # Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Â«Ñ‡Ğ°ÑĞ¸ĞºĞ¸Â»


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Inlineâ€‘Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ğ°Ğ¼ (Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ WaitingInline)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.inline_query(PSearch.WaitingInline, IsAdmin())
async def p_inline_search(query: types.InlineQuery):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº inlineâ€‘Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Â«ps: â€¦Â».

    â€¢ Ğ¡Ñ€ĞµĞ·Ğ°ĞµÑ‚ Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ `ps:`.
    â€¢ Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ ĞºĞ¾Ñ€Ğ¾Ñ‡Ğµ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² (ÑƒĞ¼ĞµĞ½ÑŒÑˆĞ°ĞµĞ¼ Ğ±ĞµÑĞ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğ¹ Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº).
    â€¢ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ´Ğ¾ 25 Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ `InlineQueryResultArticle`.
    â€¢ ĞŸÑ€Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ inlineâ€‘Ñ…Ğ¸Ğ½Ñ‚ Â«ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾Â».
    """
    text = query.query.lstrip()

    # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ Â«ps:Â» (Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€ Ğ½ĞµĞ²Ğ°Ğ¶ĞµĞ½)
    if text.lower().startswith("ps:"):
        text = text[3:].lstrip()

    # ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°, Ğ¸Ğ½Ğ°Ñ‡Ğµ Telegram Ğ¾Ñ‚ĞºĞ°Ğ¶ĞµÑ‚ÑÑ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ (Ğ¸ Ğ·Ñ€Ñ Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ‘Ğ”)
    if len(text) < 2:
        return await query.answer([], cache_time=1)

    # Ğ˜Ñ‰ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹â€‘ĞĞ•â€‘Ğ±Ğ¾Ñ‚Ğ¾Ğ² (is_bot_user=False)
    users = search_users_by_fio(text, limit=25, is_bot_user=False)
    if not users:
        return await query.answer(
            [], cache_time=1,
            switch_pm_text="ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾", switch_pm_parameter="ps_not_found",
        )

    # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ Telegram (id Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ str)
    results = [
        InlineQueryResultArticle(
            id=str(u["id"]),
            title=u["full_name"],
            description=f"Ğ¢Ğ¸Ğº: {u.get('tik', 'â€“')}",
            input_message_content=InputTextMessageContent(message_text=f"#PID{u['id']}")
        )
        for u in users
    ]
    await query.answer(results, cache_time=1)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ» Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ (#PID<ID>)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.message(PSearch.WaitingInline, F.text.startswith("#PID"), IsAdmin())
async def p_show_card(msg: types.Message, state: FSMContext):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹.

    Ğ¨Ğ°Ğ³Ğ¸:
    1. ĞŸĞ°Ñ€ÑĞ¸Ğ¼ ID Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ²Ğ¸Ğ´Ğ° Â«#PID123Â».
    2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹ (`get_participant_card`).
    3. Ğ¡Ñ‚Ñ€Ğ¾Ğ¸Ğ¼ Ñ‚ĞµĞºÑÑ‚ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ + ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ `card_kb()`.
    4. ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµâ€‘Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºÑƒ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¾Ğ¹ (Ñ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ»Ğ¸ Ğ±ĞµĞ·).
       Ğ•ÑĞ»Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ (ÑÑ‚Ğ°Ñ€Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´Ñ€ĞµĞ²Ğ½ĞµĞµ, ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ¸Â Ñ‚.Ğ´.) â€”
       Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.
    5. Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Â«ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ¾ĞµÂ» ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ #PID.
    """
    # 1ï¸âƒ£  Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ID ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ° Â«#PIDâ€¦Â»
    try:
        uid = int(msg.text[4:])
    except ValueError:
        return  # Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚

    # 2ï¸âƒ£  Ğ”Ğ¾ÑÑ‚Ğ°Ñ‘Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    card = get_participant_card(uid)
    if not card:
        await msg.answer("â—ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹")
        return

    # 3ï¸âƒ£  Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ñ‹Ğ²Ğ¾Ğ´
    caption = build_admin_card_text(card)
    kb = card_kb()
    photo = get_photo_or_none(card)  # bytes | None

    # 4ï¸âƒ£  ĞœĞµĞ½ÑĞµĞ¼ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾
    prompt_id = (await state.get_data()).get("prompt_msg_id")

    try:
        if prompt_id and photo:
            # Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ + Ñ„Ğ¾Ñ‚Ğ¾ Ğ¼Ğ°Ğ³Ğ¸ĞµĞ¹ edit_message_media()
            await bot.edit_message_media(
                chat_id=msg.chat.id,
                message_id=prompt_id,
                media=InputMediaPhoto(media=photo, caption=caption, parse_mode="HTML"),
                reply_markup=kb,
            )
        elif prompt_id:
            # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµĞºÑÑ‚
            await bot.edit_message_text(
                chat_id=msg.chat.id, message_id=prompt_id,
                text=caption, parse_mode="HTML", reply_markup=kb,
            )
        else:
            raise TelegramBadRequest("no prompt_id")
    except TelegramBadRequest:
        # ğŸ‘‰  ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞºĞ°Ğ½Ğ°Ğ»?)
        if photo:
            await bot.send_photo(
                chat_id=msg.chat.id, photo=photo,
                caption=caption, parse_mode="HTML", reply_markup=kb,
            )
        else:
            await msg.answer(caption, parse_mode="HTML", reply_markup=kb)
    except TelegramAPIError as e:
        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼, Ğ½Ğ¾ Ğ²ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
        print(f"[participants] TG error: {e}")
        await msg.answer(caption, parse_mode="HTML", reply_markup=kb)

    # 5ï¸âƒ£  Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ #PIDâ€¦, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ‡Ğ°Ñ‚ Ğ±Ñ‹Ğ» Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹
    try:
        await msg.delete()
    except TelegramAPIError:
        pass  # ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ½ĞµÑ‚ â€” Ğ½Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ½Ğ° Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Â«Ñ†Ğ¸ĞºĞ»Â» (Ğ³Ğ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.callback_query(F.data.startswith("pcard:"), IsAdmin())
async def p_show_cycle(cb: types.CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ñ†Ğ¸ĞºĞ»Ğµ (Ğ³Ğ¾Ğ´Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹)."""
    _, uid, cyc = cb.data.split(":")  # pcard:<uid>:<cycle>
    uid, cyc = int(uid), int(cyc)

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ + Ğ¿Ğ¾Ğ´Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ†Ğ¸ĞºĞ»
    card = get_participant_card(uid)
    if not card:
        await cb.answer("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ", show_alert=True)
        return

    card["cycle"] = cyc

    caption = build_admin_card_text(card)

    # Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Â«ğŸ  Ğ’ Ğ¼ĞµĞ½ÑÂ»
    kb = InlineKeyboardBuilder()
    kb.button(text="ğŸ  Ğ’ Ğ¼ĞµĞ½Ñ", callback_data="a_menu")
    kb = kb.adjust(1).as_markup()

    photo = get_photo_or_none(card)
    try:
        if photo:
            await cb.message.edit_caption(caption=caption, parse_mode="HTML", reply_markup=kb)
        else:
            await cb.message.edit_text(text=caption, parse_mode="HTML", reply_markup=kb)
    except TelegramAPIError:
        # Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Â«Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒÂ»
        await cb.message.answer(caption, parse_mode="HTML", reply_markup=kb)

    await cb.answer()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. ĞšĞ½Ğ¾Ğ¿ĞºĞ° Â«ğŸ  Ğ’ Ğ¼ĞµĞ½ÑÂ»
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.callback_query(F.data == "a_menu", IsAdmin())
async def p_back_to_menu(cb: types.CallbackQuery):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°."""
    # Ğ›ĞµĞ½Ğ¸Ğ²Ğ°Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚â€‘Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ñ†Ğ¸ĞºĞ»Ğ¾Ğ²
    from admins.keyboards import get_superadmin_panel_kb

    try:
        await cb.message.edit_text("ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°:", reply_markup=get_superadmin_panel_kb())
        await cb.answer()
    except TelegramAPIError:
        # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ½Ğµ Ğ½Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ) â€” Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¸ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ğ¾Ğµ
        await cb.message.answer("ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°:", reply_markup=get_superadmin_panel_kb())
        await cb.message.delete()
